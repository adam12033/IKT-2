PDC(primary domain controller) virtuálisgép 
  2GB RAM
  20GB HDD
  2NIC (1.NAT,2.Belsõ hálózat-LAN)
  
Legyen átjárója a LAN többi gépének (iptables)
Legyen DHCP szervere a LAN többi gépének (isc-dhcp-server)
Legyen Active Directory tartományvezérlõ (Windows Server 2008 R2 szerinti mûködés - a SAMBA csomaggal)

apt install iptables isc-dhcp-server samba smbclient winbind krb5-config net-tools mc

A majdani tartománynév (realm): cegunk.lan 

/etc/network/interfaces

auto enp0s8
iface enp0s8 inet static
  address 223.255.255.254
  netmask 255.255.255.240
  network 223.255.255.240
  broadcast 223.255.255.255
  
A file mentése után: /etc/init.d/networking restart

(az ip a s paranccsal ellenõrizhetjük a beállításinkat, ha azt látjuk, hogy az enp0s3 nem kap a VirtualBox DHCP-jétõl IP címet, akkor a dhclient enp0s3 paranccsal igényeljünk újat)

Az /etc/resolv.conf állományában lesz látható, hogy kimondottan a DHCP miatt milyen tartományikörnyezetbe integrálódott a gépünk és ott NÉVFELOLDÁS érdekében milyen DNS szervert lehet használni

/etc/default/isc-dhcp-server file-ban az INTERFACESv4="enp0s8" módosítást kell elvégezni, amivel lényegében meghatározzuk, hogy a DHCP szolgáltatás melyik hálózati kártyánkon fog megtörténni.

/etc/dhcp/dhcpd.conf file-ban a saját tartományi körülményeink értékeinek átvezetése a feladat:

option domain-name "cegunk.lan";
option domain-name-servers 223.255.255.254;

subnet 223.255.255.240 netmask 255.255.255.240 {
  range 223.255.255.241 223.255.255.253;
  option routers 223.255.255.254;
}


/etc/init.d/isc-dhcp-server restart újraindítjuk az új körülémények figyelembe vételével a DHCP szolgáltatást

Az iptables csomagszûrõ szabályával gondoskodnunk kell az átjárói funkcionalitásról:

/etc/sysctl.conf

net.ipv4.ip_forward=1
(az aktuális mûködésre nem gyakorol hatást ezért /proc/sys/net/ipv4/ip_forward bejegyzésnél is szerepeltetni kell az 1 értéket)

Az iptables segíségével meg kell fogalmaznunk a NAT-olást, amit majd, mint korábban beállított és elmentett szabályt, fogunk a boot-oláskor visszaállítani

iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE

(iptables -L az ún. filter tábla láncain megadott szabályokat listázza, iptables -t nat -L pedig a nat tábla szabályait mutatja)

Lényegében ennek a szabálynak a hatására a géprõl kifelé haladó PACKET-ekben a forráscím, megjegyezve azt, lecserélõdik az enp0s3 kártya tulajdonképpen publikus IPv4 címére, hogy az így továbbitott kérésre érkezõ válasz visszataláljon az enp0s3-hoz, ahol a korábban elmentett forráscímre kell az enp0s3 címét lecserélni.

Mivel az iptables szabályok újraindításkor törlõdnek nekünk a most beállíottat el kell tárolnunk, hogy boot-oláskor legyen az majd visszaállítható.

iptables-save >~/nat.szabaly

(cat /root/nat.szabaly megmutatja az elmenetett file tartalmát)

/etc/init.d könyvtárban helyezhetõk el azok a shell-script-ek, amik különbözõ rendszerüzemmódok (runlevel) esetén automatikusan mûködésbe lépnek a boot-oláskor
A tényleges indítás egy rcX.d könyvtárban elhelyezett link alapján történik, nekünk a runlevel megállapítása következtében az rc5.d könyvtár lesz irányadó.

touch nattolto

Majd szerkesztve az üresen létrehozott file-t:

#!/bin/bash
/usr/sbin/iptables-restore</root/nat.szabaly

(which iptables-restore meg tudjuk állapítani, hogy mely könyvtárban található az adott program)

/etc/init.d könyvtárban állva a chmod +x nattolto paranccsal tudjuk elérni, hogy ez az egyszerû szövges file, mint futtatható shell-script legyen késõbb használható.


apropos link paranccsal nézhetjük meg az OS ötleteit, amik link szóval kapcsolatosak
(Amit a Midnight Commander Fájl menüpontja Szim.link funkciójával oldottunk meg, azt az ln paranccsal is megtehettük volna)

Mivel szükséges még a tartományi mûködés konfigurálása oldjuk meg azt is:

/etc/samba/smb.conf file az aktuális mûködési körülményeket tartalmazza, amit meg akarunk õrizni (smb.conf.EREDETI)

samba-tool domain provision

Realm: cegunk.lan
Domain [cegunk]:
Sever Role [dc]: 
DNS backend [SAMBA_INTERNAL]: 
DNS forwarders's IP [172.16.16.249]:
Administrator password: Titok2022
(ez a felhasználó a tartományi környezet és nem a Linux operációs rendszerû gép user-e)

A tartományi környezet beállításai után másoljuk át a /var/lib/samba/private/krb5.conf állományát az /etc könyvtárba

Mindezek után gondoskodnunk kell, hogy a megfelelõ tartományi háttérfunkcionalitások mûködjenek, lépjenek mûködésbe a boot-oláskor:

systemctl stop smbd nmbd winbind
systemctl disable smbd nmbd winbind
systemctl unmask samba-ad-dc
systemctl start samba-ad-dc
systemctl enable samba-ad-dc


shutdown -r now

samba-tool computer list
samba-tool computer show pdc
(jónéhány parancs esetén szükséges lehet legalább a -U Administrator opciót használni, ami arra kell, hogy az adott parancs ne a root user nevében, hanem a tartományi környezet, és ennek következtében annak teljhatalmú ura az Adminstrator nevében hajtódjon végre)

samba-tool user list

A samba-tool user add paranccsal hozzunk létre egy tartományi felhasználót

A tartományvezérlõ Linux gépen az /etc/resolv.conf file-ba be kell tenni a nameserver 127.0.0.1 sort (névszerverek közül elsõként), hogy maga a gép is tudjon NÉVFELOLDÁST végezni, azonban ez a resolv.conf újraindítás után felülíródik a korábbi tartalomra és ha ezt szeretnénk kivédeni akkor használni chattr +i /etc/resolv.conf parancsot és így módosíthatatlan lesz a file